(function(t){typeof define=="function"&&define.amd?define(t):t()})((function(){"use strict";let t,u;const m=new Date("3000-01-01"),g="#DCDCDC",R="#000000";let I,T=[],D=new Map,b=null;const U=new Set(["reference","type","tags","description","deadline","responsable","notes","status"]);window.addEventListener("load",async e=>{t=new WidgetSDK,u=await t.loadTranslations(["widget.js"]);const a=`If empty, the widget use the column properties (based on choices or references) to make the list. Else, you can either:
‚Ä¢ Provides a list, separated by ";"
‚Ä¢ Provides a reference to a table or a column starting with a "$" ($TableID or $TableID.ColumnID)`;t.configureOptions([WidgetSDK.newItem("columns",null,"Behavior","Configure the behavior of each columns","Columns",{columnId:"STATUT",template:[WidgetSDK.newItem("addbutton",!0,"Can add card","If checked, display a button to add card to the column."),WidgetSDK.newItem("isdone",!1,"Is done","If checked, cards in the columns are considered as over."),WidgetSDK.newItem("useconfetti",!1,"Use confetti","If checked, confetti apprear when a card enter in the column.")]}),WidgetSDK.newItem("ref","","References","List of task references available.","Cards options",{description:a,columnId:"REFERENCE_PROJET",type:"lookup"}),WidgetSDK.newItem("types","","Type","List of task types available.","Cards options",{description:a,columnId:"TYPE",type:"lookup"}),WidgetSDK.newItem("card_fields_by_type",[],"Card fields by type","Define which fields are shown on cards for each type.","Cards options",{type:"templateform",description:"Fields tokens: reference, type, tags, description, deadline, responsable, notes, status. Use comma or semicolon list.",template:[WidgetSDK.newItem("type","","Type","Type value to match (case-insensitive)"),{id:"fields",default:"",title:"Fields",subtitle:"Comma/semicolon list of fields to show",type:"longstring"}]}),WidgetSDK.newItem("incharge","","In charge","List of people that can be in charge of the task.","Cards options",{description:a,columnId:"RESPONSABLE",type:"lookup"}),WidgetSDK.newItem("cardcolor","","Card color","List of color available for card background.","Cards options",{description:a,columnId:"COULEUR",type:"lookup"}),WidgetSDK.newItem("rotation",!0,"Tilt","If checked, cards are randomly tilted.","Display"),WidgetSDK.newItem("compact",!1,"Compact","If checked, use a compact rendering.","Display"),WidgetSDK.newItem("readonly",!1,"Read only","If checked, kanban is ready only.","Display"),WidgetSDK.newItem("hideedit",!1,"Hide editing form","If checked, hide the editing form when click on a card.","Display"),WidgetSDK.newItem("gristeditcard",!1,"Grist Record Card","If checked, opens the grist record card on double click.","Display")],"#config-view","#main-view",{onOptChange:w,onOptLoad:w}),t.initMetaData(),t.ready({requiredAccess:"full",allowSelectBy:!0,columns:[{name:"STATUT",title:"Status",description:"Defines the Kanban column",type:"Choice",strictType:!0},{name:"DESCRIPTION",title:"Task",description:"Task name",type:"Any"},{name:"DESCRIPTION_DISPLAY",title:"Task Display",description:"Displayed card content (e.g. a formula column adding html)",type:"Any",optional:!0},{name:"DEADLINE",title:"Deadline",description:"Can also be use as priority",type:"Date",optional:!0},{name:"REFERENCE_PROJET",title:"Reference",description:"Reference associated with the task",type:"Any",optional:!0},{name:"TYPE",title:"Type",description:"Type associated with the task",type:"Any",optional:!0},{name:"RESPONSABLE",title:"In charge",description:"Who is in charge",type:"Any",optional:!0},{name:"CREE_PAR",title:"Created by",type:"Any",optional:!0},{name:"CREE_LE",title:"Creation date",type:"DateTime",optional:!0},{name:"DERNIERE_MISE_A_JOUR",title:"Last update date",description:"Updated after any change",type:"DateTime",optional:!0},{name:"NOTES",title:"Notes",description:"Additional notes",type:"Any",optional:!0},{name:"COULEUR",title:"Card color",description:"Choice or html value",type:"Choice,Text",optional:!0},{name:"TAGS",title:"Tags",description:"Additional fields to display",type:"Any",optional:!0,allowMultiple:!0}]}),t.onRecords(v,{expandRefs:!1,keepEncoded:!1,mapRef:!0}),t.isLoaded().then(async()=>{t.initDone=!0}),grist.on("message",async n=>{n.mappingsChange&&P()})});async function v(e){I=e;const a=document.getElementById("conteneur-kanban");a.innerHTML="";const n=await t.col.STATUT.getChoices();if(!n||n.length===0){console.error(u("No choice available in the Status column"));return}n.forEach((o,s)=>{a.appendChild(N(o,s))}),e?.length>0&&(e.forEach(o=>{const s=M(o),i=document.querySelector(`.contenu-colonne[data-statut="${o.STATUT}"]`);i&&i.insertBefore(s,i.firstChild)}),t.opt.readonly||document.querySelectorAll(".contenu-colonne").forEach(o=>{new Sortable(o,{group:"kanban-todo",animation:150,onEnd:async function(s){const i=s.to.dataset.statut;if(i===s.from.dataset.statut){if(t.map.DEADLINE){let r=s.item.dataset.deadline||"9999-12-31";if(s.oldIndex!==s.newIndex&&new Date(r)>=m){let l=m.getFullYear(),E=[];document.querySelectorAll(".contenu-colonne").forEach(p=>{p.getAttribute("data-statut")===i&&p.querySelectorAll(".carte").forEach(async c=>{r=c.getAttribute("data-deadline")||"9999-12-31",new Date(r)>=m&&(r=`${l}-01-01`,c.setAttribute("data-deadline",r),l+=1,E.push(t.formatRecord(c.getAttribute("data-todo-id"),{DEADLINE:r})))})});try{await t.updateRecords(E)}catch(p){console.error(u("Error during status update:"),p)}}}}else try{await $(s.item.dataset.todoId,"STATUT",i)}catch(r){console.error(u("Error during status update:"),r)}O(o)}}),O(o)}),document.querySelectorAll(".colonne-kanban").forEach(B))}async function w(e){await t.isMapped(),F(),v(I)}function N(e,a){const n=t.opt.columns[a],o=document.createElement("div");return o.className=`colonne-kanban${!n.addbutton&&!t.opt.compact?" colonne-nobouton":""}`,o.id=e,localStorage.getItem(`column-todo-${e}`)==="true"&&o.classList.add("collapsed"),o.innerHTML=`
        <div class="entete-colonne" style="background-color: ${t.col.STATUT.getColor(e)??g};color:${t.col.STATUT.getTextColor(e)??R}">
            <div class="titre-statut">${e} <span class="compteur-colonne">(0)</span></div>
            ${n.addbutton&&!t.opt.readonly?`
            <button class="bouton-ajouter-entete ${t.opt.compact?" compact":""}" onclick="creerNouvelleTache('${e}')">+</button>
            `:""}
            <button class="bouton-toggle" onclick="toggleColonne(this.closest('.colonne-kanban'), event)">‚áÑ</button>
        </div>
        ${n.addbutton&&!t.opt.readonly?`
            <button class="bouton-ajouter ${t.opt.compact?" compact":""}" onclick="creerNouvelleTache('${e}')">+ ${u("Add a new task")}</button>
        `:""}
        <div class="contenu-colonne" data-statut="${e}"></div>
    `,o}function P(){const e=document.getElementsByClassName("colonne-kanban");Array.prototype.forEach.call(e,a=>{a.style=`background-color: ${t.col.STATUT.getColor(a.id)??g};color:${t.col.STATUT.getTextColor(a.id)??R}`}),k()}async function k(){await t.isMapped(),T=[],t.map.TAGS&&(T=await t.map.TAGS.map(async e=>await(await t.meta.getColMeta(e))?.getChoices()??[]),T=await Promise.all(T))}function F(){const e=Array.isArray(t.opt.card_fields_by_type)?t.opt.card_fields_by_type:[],a=new Map;let n=null;e.forEach(o=>{if(!o)return;const s=(o.type??o.type_value??o.id??"").toString().trim();if(!s)return;const i=L(s),r=J(o.fields??o.field??o.field_list??"");i==="__default__"?n=r:a.set(i,r)}),D=a,b=n}function L(e){const a=(e??"").toString().trim().toLowerCase();return!a||a==="*"||a==="default"?"__default__":a}function J(e){const n=(e??"").toString().split(/[;,|\n]+/),o=new Set;return n.forEach(s=>{const i=x(s);i&&o.add(i)}),o}function x(e){const a=(e??"").toString().trim().toLowerCase();return a?["ref","reference","project","projet"].includes(a)?"reference":["type"].includes(a)?"type":["tag","tags"].includes(a)?"tags":["desc","description","task"].includes(a)?"description":["deadline","date","due"].includes(a)?"deadline":["responsable","assignee","owner","incharge"].includes(a)?"responsable":["notes","note","comment","comments"].includes(a)?"notes":["status","done","stamp"].includes(a)?"status":"":""}function _(e){const a=L(e),n=D.get(a)??b??U;return{reference:n.has("reference"),type:n.has("type"),tags:n.has("tags"),description:n.has("description"),deadline:n.has("deadline"),responsable:n.has("responsable"),notes:n.has("notes"),status:n.has("status")}}function M(e){const a=document.createElement("div");a.className=`carte ${t.opt.rotation?"":" norotate"}${t.opt.compact?" compact":""}`,a.setAttribute("data-todo-id",e.id),a.setAttribute("data-last-update",e.DERNIERE_MISE_A_JOUR||""),a.setAttribute("data-deadline",e.DEADLINE||""),e.COULEUR&&t.col.COULEUR.type==="Choice"&&(t.col.COULEUR.getColor(e.COULEUR)?a.setAttribute("style",`background-color: ${t.col.COULEUR.getColor(e.COULEUR)}`):a.setAttribute("style",`background-color: ${(e.COULEUR.startsWith("#")?"":"#")+e.COULEUR}`));const n=e.TYPE||"",o=e.DESCRIPTION_DISPLAY||e.DESCRIPTION||u("No description"),s=e.DEADLINE?C(e.DEADLINE):"",i=e.RESPONSABLE||"",r=e.REFERENCE_PROJET,l=e.TAGS||[];let E="";l.forEach(d=>E+=d?`<div class="more-tag">${d}</div>`:"");const p=t.getValueListOption("columns",e.STATUT),c=_(n);return a.innerHTML=`
        ${c.reference&&r&&r.length>0?`<div class="projet-ref truncate">#${r}</div>`:""}
        ${c.type&&n?`<div class="type-tag truncate">${n}</div>`:""}
        ${c.tags&&l.length>0?`<div>${E}</div>`:""}
        ${c.description?`<div class="description">${o}</div>`:""}
        ${c.deadline&&s?`<div class="deadline${e.DEADLINE<Date.now()?" late":""} truncate">üìÖ ${s}</div>`:""}
        ${c.responsable&&i?`<div class="responsable-badge truncate">${i}</div>`:""}
        ${c.status&&p?.isdone?`<div class="tampon-termine" style="color: ${t.col.STATUT.getColor(e.STATUT)??g};">${e.STATUT}</div>`:""}      
    `,a.addEventListener("click",()=>{grist.setCursorPos({rowId:e.id}),t.opt.hideedit||S(e)}),a.addEventListener("dblclick",()=>{grist.setCursorPos({rowId:e.id}),t.opt.gristeditcard?grist.commandApi.run("viewAsCard"):t.opt.hideedit||S(e)}),a}async function $(e,a,n,o){try{if(o?.stopPropagation(),a==="STATUT"){const i=t.getValueListOption("columns",n);i&&i.useconfetti&&Y()}let s={[a]:n||void 0};t.map.DERNIERE_MISE_A_JOUR&&(s.DERNIERE_MISE_A_JOUR=new Date().toISOString()),await t.updateRecords(t.formatRecord(e,s))}catch(s){console.error(u("Error during update:"),s)}}function O(e){const a=Array.from(e.children),n=e.dataset.isdone;a.sort((o,s)=>{let i=0;if(t.map.DEADLINE)if(n){const r=o.getAttribute("data-last-update")||"1970-01-01",l=s.getAttribute("data-last-update")||"1970-01-01";i=new Date(l)-new Date(r)}else{const r=o.getAttribute("data-deadline")||"9999-12-31",l=s.getAttribute("data-deadline")||"9999-12-31";i=new Date(r)-new Date(l)}if(i===0){const r=parseInt(o.getAttribute("data-todo-id"))||0,l=parseInt(s.getAttribute("data-todo-id"))||0;return r-l}else return i}),a.forEach(o=>e.appendChild(o))}function B(e){const a=e.querySelector(".contenu-colonne"),n=e.querySelector(".compteur-colonne");a&&n&&(n.textContent=`(${a.children.length})`)}function S(e){const a=document.getElementById("popup-todo"),n=document.querySelector(".carte.active"),o=document.querySelector(`[data-todo-id="${e.id}"]`),s=t.getValueListOption("columns",e.STATUT),i=_(e.TYPE||"");if(t.opt.readonly){y();return}n?.classList.remove("active"),o?.classList.add("active"),a.style=`border-left-color: ${t.col.STATUT.getColor(e.STATUT)??g}`,a.dataset.statut=e.STATUT,a.dataset.isdone=s?!1:s.isdone,a.dataset.currentTodo=e.id;const r=a.querySelector(".popup-title"),l=a.querySelector(".popup-content"),E=a.querySelector(".popup-header");E.style=`background-color: ${t.col.STATUT.getColor(e.STATUT)??g};color:${t.col.STATUT.getTextColor(e.STATUT)??R}`;const p=a.querySelector(".bouton-fermer");p.style=`color:${t.col.STATUT.getTextColor(e.STATUT)??R}`,r.textContent=e.DESCRIPTION||u("New task");let c=1,d='<div class="field-row">';t.map.DEADLINE&&i.deadline&&(d+=`
            <div class="field">
            <label class="field-label">${t.map.DEADLINE}</label>
            <input type="date" class="field-input" 
                    value="${G(e.DEADLINE)}"
                    onchange="mettreAJourChamp(${e.id}, 'DEADLINE', this.value, event)">
            </div>
        `),t.map.REFERENCE_PROJET&&i.reference&&(d+=h(e.id,e.REFERENCE_PROJET,t.valuesList.ref,t.map.REFERENCE_PROJET,"REFERENCE_PROJET",t.col.REFERENCE_PROJET.getIsFormula()),c+=1),c%2===0&&(d+='</div><div class="field-row">'),t.map.TYPE&&i.type&&(d+=h(e.id,e.TYPE,t.valuesList.types,t.map.TYPE,"TYPE",t.col.TYPE.getIsFormula()),c+=1),c%2===0&&(d+='</div><div class="field-row">'),t.map.RESPONSABLE&&i.responsable&&(d+=h(e.id,e.RESPONSABLE,t.valuesList.incharge,t.map.RESPONSABLE,"RESPONSABLE",t.col.RESPONSABLE.getIsFormula()),c+=1),c%2===0&&(d+='</div><div class="field-row">'),t.map.TAGS&&i.tags&&t.map.TAGS.forEach((A,f)=>{d+=h(e.id,e.TAGS[f],T[f],A,A,t.col.TAGS[f].getIsFormula()),c+=1,c%2===0&&(d+='</div><div class="field-row">')}),t.map.COULEUR&&(d+=h(e.id,e.COULEUR,t.valuesList.cardcolor,t.map.COULEUR,"COULEUR"),t.col.COULEUR.getIsFormula(),c+=1),d+="</div>",t.map.DESCRIPTION&&i.description&&(d+=`
        <div class="field">
            <label class="field-label">${t.map.DESCRIPTION}</label>
            <textarea class="field-textarea auto-expand" 
                    onchange="mettreAJourChamp(${e.id}, 'DESCRIPTION', this.value, event)"
                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'">${e.DESCRIPTION||""}</textarea>
        </div>
    `),t.map.NOTES&&i.notes&&(d+=`<div class="field">
            <label class="field-label">${t.map.NOTES}</label>
            <textarea class="field-textarea auto-expand" 
                      onchange="mettreAJourChamp(${e.id}, 'NOTES', this.value, event)"
                      oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'">${e.NOTES||""}</textarea>
          </div>
        `),(t.map.CREE_LE&&e.CREE_LE||t.map.CREE_PAR&&e.CREE_PAR||t.map.DERNIERE_MISE_A_JOUR&&e.DERNIERE_MISE_A_JOUR)&&(d+=`<div class="info-creation">
                ${u("Created")} ${t.map.CREE_LE&&e.CREE_LE?u("on %on",{on:C(e.CREE_LE)}):""} 
                ${t.map.CREE_PAR&&e.CREE_PAR?u("by %by",{by:e.CREE_PAR||"-"}):""}
                ${t.map.DERNIERE_MISE_A_JOUR&&e.DERNIERE_MISE_A_JOUR?"<br>"+u("Last update on %on",{on:C(e.DERNIERE_MISE_A_JOUR)||"-"}):""}
            </div>
        `),t.opt.readonly||(d+=` 
          <div class="popup-actions">
            <button class="popup-action-button bouton-supprimer" onclick="supprimerTodo(${e.id}, event)" 
                    title="${u("Remove the task")}">üóëÔ∏è</button>
          </div>
        `),l.innerHTML=d,setTimeout(()=>{document.querySelectorAll(".auto-expand").forEach(f=>{f.style.height="",f.style.height=f.scrollHeight+"px"})},0),a.classList.add("visible")}function h(e,a,n,o,s,i){let r="";return n?.length>0?n.length<10?(r+=`
                <div class="field">
                    <label class="field-label">${o}</label>
                    <select class="field-select" onchange="mettreAJourChamp(${e}, '${s}', this.value, event)">
                    <option value="" ${i?"disabled":""}></option>`,n.forEach(l=>{r+=`<option value="${l}" ${a===l?"selected":""}>${l}</option>`}),r+=`</select>
                </div>        
            `):(r+=`
                <div class="field">
                    <label class="field-label">${o}</label>
                    <input type="text" list="list-${s}" class="field-select" onchange="mettreAJourChamp(${e}, '${s}', this.value, event)" ${i?"disabled":""}/>
                    <datalist id="list-${s}">`,n.forEach(l=>{r+=`<option value="${l}" ${a===l?"selected":""}>${l}</option>`}),r+=`</datalist>
                </div>        
            `):r+=`
            <div class="field">
                <label class="field-label">${o}</label>
                <input type="text" class="field-input" value="${a||""}" 
                    onchange="mettreAJourChamp(${e}, '${s}', this.value, event)" ${i?"disabled":""}>
            </div>
        `,r}function y(){const e=document.getElementById("popup-todo"),a=e.dataset.currentTodo,n=document.querySelector(`[data-todo-id="${a}"]`);n&&n.classList.remove("active"),e.classList.remove("visible")}document.addEventListener("keydown",e=>{e.key==="Escape"&&y()}),document.addEventListener("click",e=>{const a=document.getElementById("popup-todo");a.classList.contains("visible")&&!a.querySelector(".popup-content").contains(e.target)&&!e.target.closest(".carte")&&!e.target.closest(".popup-header")&&y()});async function K(e){try{let a={DESCRIPTION:"",STATUT:e};t.map.TYPE&&!t.col.TYPE.getIsFormula()&&(a.TYPE=""),t.map.REFERENCE_PROJET&&!t.col.REFERENCE_PROJET.getIsFormula()&&(a.REFERENCE_PROJET=null),t.map.DERNIERE_MISE_A_JOUR&&!t.col.DERNIERE_MISE_A_JOUR.getIsFormula()&&(a.DERNIERE_MISE_A_JOUR=new Date().toISOString()),t.map.CREE_LE&&!t.col.CREE_LE.getIsFormula()&&(a.CREE_LE=new Date().toISOString());const n=await t.createRecords({fields:a});if(n.id&&n.id>0){const o=await t.fetchSelectedRecord(n.id);grist.setCursorPos({rowId:n.id}),t.opt.hideedit||S(o)}}catch(a){console.error(u("Error on creation:"),a)}}async function q(e,a){if(a?.stopPropagation(),confirm(u("Are you sure you want to delete this task?")))try{await t.destroyRecords(e),y()}catch(n){console.error(u("Error on delete:"),n)}}function W(e,a){a?.stopPropagation(),e.classList.toggle("collapsed"),localStorage.setItem(`column-todo-${e.querySelector(".titre-statut").textContent.trim()}`,e.classList.contains("collapsed"))}function Y(){const a=Date.now()+2e3,n={startVelocity:30,spread:360,ticks:60,zIndex:0};function o(i,r){return Math.random()*(r-i)+i}const s=setInterval(function(){const i=a-Date.now();if(i<=0)return clearInterval(s);const r=50*(i/2e3);confetti(Object.assign({},n,{particleCount:r,origin:{x:o(.1,.3),y:Math.random()-.2}})),confetti(Object.assign({},n,{particleCount:r,origin:{x:o(.7,.9),y:Math.random()-.2}}))},250)}function C(e){if(!e)return"-";const a=new Date(e);if(a>=m)return null;const n=a.getDate().toString().padStart(2,"0"),o=a.toLocaleDateString(t.cultureFull,{month:"short"}),s=a.getFullYear();return`${n} ${o} ${s}`}function G(e){if(!e)return"";try{const a=new Date(e);return a>=m?"":a.toISOString().split("T")[0]}catch(a){return console.error(u("Error on date formating:"),a),""}}window.toggleColonne=W,window.togglePopupTodo=S,window.fermerPopup=y,window.mettreAJourChamp=$,window.creerNouvelleTache=K,window.supprimerTodo=q}));
